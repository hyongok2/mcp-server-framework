# =============================================================================
# ğŸ“ docker/stdio-compose.yml - STDIO ì „ìš© (Claude Desktopìš©)
# =============================================================================
version: '3.8'

services:
  mcp-server:
    image: mcp-server:latest
    container_name: mcp-server-stdio
    stdin_open: true          # -i ì˜µì…˜ (STDIO í•„ìˆ˜)
    tty: false               # TTY ë¹„í™œì„±í™” (STDIOì—ì„œ ë¶ˆí•„ìš”)
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./tools:/app/tools:ro
      - ./docs:/app/docs:ro
      - ./prompts:/app/prompts:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Features__EnableStdio=true
      - Features__EnableHttp=false
      - Logging__MinLevel=Info
    network_mode: none        # ë„¤íŠ¸ì›Œí¬ ë¶ˆí•„ìš”
    mem_limit: 512m          # ë©”ëª¨ë¦¬ ì œí•œ
    cpus: 1.0               # CPU ì œí•œ
    restart: "no"           # Claude Desktopì´ ê´€ë¦¬

---
# =============================================================================
# ğŸ“ docker/http-compose.yml - HTTP ì„œë¹„ìŠ¤ìš©
# =============================================================================
version: '3.8'

services:
  mcp-server:
    image: mcp-server:latest
    container_name: mcp-server-http
    ports:
      - "5000:5000"
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./tools:/app/tools:ro
      - ./docs:/app/docs:ro
      - ./prompts:/app/prompts:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Features__EnableStdio=false
      - Features__EnableHttp=true
      - Logging__MinLevel=Info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    mem_limit: 512m
    cpus: 1.0

---
# =============================================================================
# ğŸ“ docker/dev-compose.yml - ê°œë°œ í™˜ê²½ìš©
# =============================================================================
version: '3.8'

services:
  mcp-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: build           # ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ ì¤‘ë‹¨
    container_name: mcp-server-dev
    stdin_open: true
    tty: false
    volumes:
      - ../src:/src           # ì†ŒìŠ¤ ì½”ë“œ ë§ˆìš´íŠ¸
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./tools:/app/tools:ro
      - ./docs:/app/docs:ro
      - ./prompts:/app/prompts:ro
    working_dir: /src
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_USE_POLLING_FILE_WATCHER=true
      - Features__EnableStdio=true
      - Features__EnableHttp=false
      - Logging__MinLevel=Debug
    command: ["dotnet", "run", "--project", "Micube.MCP.Server"]
    network_mode: none
    restart: "no"

---
# =============================================================================
# ğŸ“ docker/prod-compose.yml - í”„ë¡œë•ì…˜ìš©
# =============================================================================
version: '3.8'

services:
  mcp-server:
    image: mcp-server:v1.0.0  # íŠ¹ì • ë²„ì „ ì‚¬ìš©
    container_name: mcp-server-prod
    stdin_open: true
    tty: false
    volumes:
      - /etc/mcp-server/config:/app/config:ro
      - /var/log/mcp-server:/app/logs
      - /opt/mcp-server/tools:/app/tools:ro
      - /opt/mcp-server/docs:/app/docs:ro
      - /opt/mcp-server/prompts:/app/prompts:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Features__EnableStdio=true
      - Features__EnableHttp=false
      - Logging__MinLevel=Info
      - Logging__File__RetentionDays=90
    network_mode: none
    mem_limit: 1g
    cpus: 2.0
    restart: "no"
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp

---
# =============================================================================
# ğŸ“ docker-compose.yml - í†µí•© ì„¤ì • (í”„ë¡œíŒŒì¼ ì‚¬ìš©)
# =============================================================================
version: '3.8'

services:
  # STDIO ì„œë¹„ìŠ¤ (ê¸°ë³¸)
  mcp-server:
    build:
      context: .
      dockerfile: docker/Dockerfile
    stdin_open: true
    tty: false
    volumes:
      - ./docker/config:/app/config:ro
      - ./docker/logs:/app/logs
      - ./docker/tools:/app/tools:ro
      - ./docker/docs:/app/docs:ro
      - ./docker/prompts:/app/prompts:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - Features__EnableStdio=true
      - Features__EnableHttp=false
    profiles: ["stdio", "default"]
    network_mode: none
    restart: "no"

  # HTTP ì„œë¹„ìŠ¤
  mcp-http:
    extends: mcp-server
    ports:
      - "${HTTP_PORT:-5000}:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - Features__EnableStdio=false
      - Features__EnableHttp=true
    profiles: ["http"]
    network_mode: bridge
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ê°œë°œ ì„œë¹„ìŠ¤
  mcp-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: build
    stdin_open: true
    tty: false
    volumes:
      - ./src:/src
      - ./docker/config:/app/config:ro
      - ./docker/logs:/app/logs
    working_dir: /src
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_USE_POLLING_FILE_WATCHER=true
      - Features__EnableStdio=true
      - Logging__MinLevel=Debug
    command: ["dotnet", "run", "--project", "Micube.MCP.Server"]
    profiles: ["dev"]
    network_mode: none
    restart: "no"

---
# =============================================================================
# ğŸ“ docker/multi-service-compose.yml - ë‹¤ì¤‘ ì„œë¹„ìŠ¤ ì„¤ì •
# =============================================================================
version: '3.8'

services:
  # ê¸°ë³¸ MCP ì„œë²„
  mcp-primary:
    image: mcp-server:latest
    container_name: mcp-primary
    stdin_open: true
    tty: false
    volumes:
      - ./config/primary:/app/config:ro
      - ./logs/primary:/app/logs
      - ./tools/primary:/app/tools:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Features__EnableStdio=true
    network_mode: none
    restart: "no"

  # ê°œë°œìš© MCP ì„œë²„
  mcp-development:
    image: mcp-server:dev
    container_name: mcp-dev
    stdin_open: true
    tty: false
    volumes:
      - ./config/dev:/app/config:ro
      - ./logs/dev:/app/logs
      - ./tools/dev:/app/tools:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - Logging__MinLevel=Debug
    network_mode: none
    restart: "no"

  # í…ŒìŠ¤íŠ¸ìš© MCP ì„œë²„
  mcp-testing:
    image: mcp-server:test
    container_name: mcp-test
    stdin_open: true
    tty: false
    volumes:
      - ./config/test:/app/config:ro
      - ./logs/test:/app/logs
      - ./tools/test:/app/tools:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Testing
      - Features__EnableStdio=true
    network_mode: none
    restart: "no"